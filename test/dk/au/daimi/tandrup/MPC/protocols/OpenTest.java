package dk.au.daimi.tandrup.MPC.protocols;

import static org.junit.Assert.*;

import java.io.IOException;
import java.math.BigInteger;
import java.security.GeneralSecurityException;
import java.util.Random;

import org.junit.After;
import org.junit.Before;
import org.junit.Test;

import dk.au.daimi.tandrup.MPC.math.FieldPolynomial1D;
import dk.au.daimi.tandrup.MPC.math.fields.Field;
import dk.au.daimi.tandrup.MPC.math.fields.FieldElement;
import dk.au.daimi.tandrup.MPC.math.fields.integer.BigIntegerFieldElement;
import dk.au.daimi.tandrup.MPC.net.Activity;
import dk.au.daimi.tandrup.MPC.net.ChannelProvider;
import dk.au.daimi.tandrup.MPC.net.Participant;
import dk.au.daimi.tandrup.MPC.net.CommunicationChannel;

public class OpenTest {
	private ChannelProvider channelProvider;

	@Before
	public void setUp() throws Exception {
	}

	@After
	public void tearDown() throws Exception {
		if (channelProvider != null)
			channelProvider.close();
	}

	@Test(timeout=10000)
	public void testRun() throws InterruptedException, IOException, GeneralSecurityException, ClassNotFoundException {
		final FieldElement[] res = new FieldElement[3];
		
		Activity testActivity = new Activity("test");

		channelProvider = ChannelProvider.getDefaultInstance(3);

		Participant part1 = channelProvider.getParticipant(1);
		Participant part2 = channelProvider.getParticipant(2);
		Participant part3 = channelProvider.getParticipant(3);
		
		CommunicationChannel comm1 = channelProvider.getChannel(1);
		CommunicationChannel comm2 = channelProvider.getChannel(2);
		CommunicationChannel comm3 = channelProvider.getChannel(3);

		int t = 2;
		
		Field field = (new BigIntegerFieldElement(0, BigInteger.valueOf(101))).field();
		
		FieldElement secret = field.element(42);
		
		FieldPolynomial1D poly = new FieldPolynomial1D(secret, t, new Random());
		
		final Open f1 = new Open(comm1, t, testActivity, part1, t, poly.eval(field.element(part1.getID())));
		final Open f2 = new Open(comm2, t, testActivity, part1, t, poly.eval(field.element(part2.getID())));
		final Open f3 = new Open(comm3, t, testActivity, part1, t, poly.eval(field.element(part3.getID())));
		
		class UnitTestThread extends Thread {
			public boolean failed = false;
		}
		
		UnitTestThread t1 = new UnitTestThread() {
			public void run() {
				try {
					try { Thread.sleep(100); }
					catch (InterruptedException e) {}
					FieldElement s = f1.run();;
					res[0] = s;
					System.out.println(s);
				} catch (Exception e) {
					System.err.print(this.getName() + ": ");
					e.printStackTrace();
					this.failed = true; 
				}
			}
		};
		
		UnitTestThread t2 = new UnitTestThread() {
			public void run() {
				try {
					try { Thread.sleep(100); }
					catch (InterruptedException e) {}
					FieldElement s = f2.run();;
					res[1] = s;
					System.out.println(s);
				} catch (Exception e) {
					System.err.print(this.getName() + ": ");
					e.printStackTrace();
					this.failed = true; 
				}
			}
		};

		UnitTestThread t3 = new UnitTestThread() {
			public void run() {
				try {
					try { Thread.sleep(100); }
					catch (InterruptedException e) {}
					FieldElement s = f3.run();;
					res[2] = s;
					System.out.println(s);
				} catch (Exception e) {
					System.err.print(this.getName() + ": ");
					e.printStackTrace();
					this.failed = true; 
				}
			}
		};
		
		t1.start();
		t2.start();
		t3.start();
		
		Thread.sleep(100);
		
		t1.join();
		t2.join();
		t3.join();
		
		assertFalse(t1.failed);
		assertFalse(t2.failed);
		assertFalse(t3.failed);
		
		assertEquals(secret, res[0]);
		assertEquals(secret, res[1]);
		assertEquals(secret, res[2]);
		
		channelProvider.close();
	}

}
